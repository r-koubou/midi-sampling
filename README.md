midi-sampling
================

[日本語](README_ja.md)

## Overview

`midi-sampling` performs sampling from external MIDI sound sources. It allows you to specify arbitrary MIDI notes and velocities to control MIDI devices and carry out sampling.

Since it operates from a console, it is lightweight and can automate sampling processes.

## Requirements

- Windows OS with Python 3.12 or later
  - It might also work on macOS, but this has not been verified.
- [pipenv](https://github.com/pypa/pipenv)
- [ffmpeg](https://www.ffmpeg.org/)

## Setup

### Installing pipenv

https://github.com/pypa/pipenv?tab=readme-ov-file#installation

### Installing dependencies

Navigate to the project directory and run the following command:

```bash
pipenv install
```

### Installing ffmpeg

https://www.ffmpeg.org/download.html

After installation, add the directory containing `ffmpeg.exe` to the environment variable `PATH`.

## How to Run

### Activating the pipenv environment

Navigate to the project directory and run the following command:

```bash
pipenv shell
```

If the prompt on the left side appears as `(midi-sampling)`, you are inside the pipenv environment.

```bash
(midi-sampling) C:\Path\To\Project\midi-sampling>
~~~~~~~~~~~~~~~
```

### Executing the Sampling

Run the following command:

```bash
python midisampling/sampling.py <sampling-config-file.json> <MIDI-config-file.json>
```

### Listing Devices

Run the following command:

```bash
python midisampling/devicelist.py
```

#### Output example

```
+------------------------------------------------------+
|                    Audio Devices                     |
+--------------------------------+---------------------+
| Name                           | Platform            |
+--------------------------------+---------------------+
| Line(Steinberg UR28M)          | Windows WDM-KS      |
| Microsoft Sound Mapper - Input | MME                 |
| Primary Sound Capture Driver   | Windows DirectSound |
| UR28M In (Steinberg UR28M)     | MME                 |
| UR28M In (Steinberg UR28M)     | Windows DirectSound |
| UR28M In (Steinberg UR28M)     | Windows WASAPI      |
| Yamaha Steinberg USB ASIO      | ASIO                |
+--------------------------------+---------------------+
+------------------------------+
|         MIDI Devices         |
+------------------------------+
| Name                         |
+------------------------------+
| Impact GX Mini               |
| Microsoft GS Wavetable Synth |
| MIDIOUT2 (Impact GX Mini)    |
| Roland SC-8850 MIDI OUT 1    |
| Roland SC-8850 MIDI OUT 2    |
| Roland SC-8850 PART A        |
| Roland SC-8850 PART B        |
| Roland SC-8850 PART C        |
| Roland SC-8850 PART D        |
+------------------------------+
```

## Configuration Files

Sample files, `sampling-config.json` and `midi-config.example.json`, are included. Please adjust the settings according to your environment.

<!-- [BEGIN] Generated by documenttool/jsonschema_to_markdown.py -->
### Sampling Configuration

*Configuration for device, sampling.*

#### Properties

- **`audio_channels`** *(integer, required)*: Number of channels in the sampled audio file.
- **`audio_sample_rate`** *(integer, required)*: Sampling rate of the audio file.
- **`audio_sample_bits`** *(integer, required)*: Bit depth of the sampled audio file. Must be one of: `[8, 16, 24, 32, 64]`.
- **`audio_sample_bits_format`** *(string, required)*: Format of the bit depth of the sampled audio file. Must be one of: `["int", "float"]`.
- **`audio_in_device`** *(object, required)*
  - **`name`** *(string, required)*: Name of the input device for the sampled audio file.
  - **`platform`** *(string, required)*: Platform of the input device for the sampled audio file (e.g., `ASIO`, `MME`, `Windows DirectSound`, `Windows WASAPI`, `Core Audio` etc.).
- **`asio_audio_ins`** *(array)*: Default: `[]`.
  - **Items** *(integer)*: List of ASIO input channel numbers. Specify the input channel numbers of your device. The format starts from 0 (e.g., to use inputs 1 and 2, specify `[0, 1]`).
- **`midi_out_device`** *(string, required)*: Name of the MIDI device used for sampling.
- **`target_peak`** *(number, required)*: Peak level (in dB) for the sampled audio file. Normalization is performed based on the peak level across the entire sampled file.
- **`trim_threshold`** *(number)*: Threshold (in dB) for trimming silence. Default: `-60`.
- **`trim_min_silence_duration`** *(integer)*: Minimum duration (in ms) of silence to be trimmed. Default: `250`.
#### Examples

  ```json
  {
      "audio_channels": 2,
      "audio_sample_rate": 48000,
      "audio_sample_bits": 32,
      "audio_sample_bits_format": "int",
      "audio_in_device": {
          "name": "Yamaha Steinberg USB ASIO",
          "platform": "ASIO"
      },
      "asio_audio_ins": [
          2,
          3
      ],
      "midi_out_device": "Roland SC-8850 PART A",
      "target_peak": -8,
      "trim_threshold": -60,
      "trim_min_silence_duration": 250
  }
  ```

### MIDI Sampling Configuration

*Structure of the MIDI sampling configuration.*

#### Definitions

- <a id="definitions/def_midi_config"></a>**`def_midi_config`** *(object)*: The main configuration body.
  - **`output_dir`** *(string, required)*: Directory for the output of the sampled audio files.
  - **`processed_output_dir`** *(string, required)*: Directory for the output of processed sampled audio files.
  - **`output_prefix`** *(string)*: Prefix for the filenames of the sampled audio files. Default: `""`.
  - **`pre_send_smf_path_list`** *(array)*: These file(s) will be sent to the MIDI device before sampling once e.g. GM Reset, CC Reset, etc. Default: `[]`.
    - **Items** *(string)*: Path to the SMF(*.mid/*.midi) file(s).
  - **`midi_channel`** *(integer, required)*: MIDI channel number for sampling. Minimum: `0`. Maximum: `15`.
  - **`midi_program_change_list`** *(array, required)*: List of MIDI program change (MSB, LSB, Program No) for sampling.
    - **Items** *(object)*
      - **`msb`** *(integer)*: MSB value for the MIDI program change. Minimum: `0`. Maximum: `127`.
      - **`lsb`** *(integer)*: LSB value for the MIDI program change. Minimum: `0`. Maximum: `127`.
      - **`program`** *(integer)*: Program number for the MIDI program change. Minimum: `0`. Maximum: `127`.
  - **`midi_notes`** *(object, required)*: List of MIDI note numbers to be sampled. Refer to *[#/definitions/def_midi_byte_range](#definitions/def_midi_byte_range)*.
  - **`midi_velocities`** *(array, required)*: List of MIDI velocities to be sampled. Refer to *[#/definitions/def_midi_byte_range](#definitions/def_midi_byte_range)*.
  - **`midi_pre_wait_duration`** *(number, required)*: Pre-wait time (in seconds) before sampling. A value of `0.6` or higher is recommended.
  - **`midi_note_duration`** *(integer, required)*: Length of the MIDI note to be sampled (in seconds). Only integer values can be specified.
  - **`midi_release_duration`** *(number, required)*: Wait time (in seconds) after the release of the sampled MIDI note. Only integer values can be specified.

  Examples:
  ```json
  {
      "output_dir": "_recorded",
      "processed_output_dir": "_recorded/_processed",
      "output_prefix": "output",
      "pre_send_smf_path_list": [
          "path/to/GM_Reset.mid",
          "path/to/CC_Init.mid"
      ],
      "midi_channel": 0,
      "midi_program_change_list": [
          {
              "msb": 0,
              "lsb": 0,
              "program": 0
          },
          {
              "msb": 0,
              "lsb": 0,
              "program": 1
          },
          {
              "msb": 0,
              "lsb": 0,
              "program": 2
          }
      ],
      "midi_notes": [
          {
              "from": 40,
              "to": 41
          },
          80
      ],
      "midi_velocities": [
          127
      ],
      "midi_pre_wait_duration": 0.6,
      "midi_note_duration": 2,
      "midi_release_duration": 1.5
  }
  ```

- <a id="definitions/def_midi_byte_range"></a>**`def_midi_byte_range`** *(array)*: In addition to an array of individually contiguous MIDI message byte values, it supports the representation of a specified range.
  - **`data`**
    - **Any of**
      - *integer*: Byte value. Minimum: `0`. Maximum: `127`.
      - *object*: Range of byte values.
        - **`from`** *(integer, required)*: From byte value. Minimum: `0`. Maximum: `127`.
        - **`to`** *(integer, required)*: To byte value. Minimum: `0`. Maximum: `127`.

  Examples:
  ```json
  [
      40,
      41
  ]
  ```

  ```json
  [
      {
          "from": 10,
          "to": 100
      }
  ]
  ```

  ```json
  [
      40,
      41,
      {
          "from": 10,
          "to": 100
      }
  ]
  ```

<!-- [END] Generated by documenttool/jsonschema_to_md.py -->
