midi-sampling
================


## 概要

`midi-sampling`は外部のMIDI音源からサンプリングを行います。
任意のMIDIノート・ベロシティを指定して、MIDIデバイスを制御し、サンプリングを行います。

コンソールベースで動作するため、軽量でサンプリングの自動化が可能です。

## 動作に必要なもの

- Python 3.12 以上が動作する Windows OS
  - macOSでも動作すると思いますが、未検証です
- [pipenv](https://github.com/pypa/pipenv)
- [ffmpeg](https://www.ffmpeg.org/)

## セットアップ

### pipenvのインストール

https://github.com/pypa/pipenv?tab=readme-ov-file#installation

### 依存パッケージのインストール

プロジェクトのディレクトリに移動し、以下のコマンドを実行します。

```bash
pipenv install
```

### ffmpegのインストール

https://www.ffmpeg.org/download.html

インストール後、環境変数 `PATH` に ffmpeg.exe があるディレクトリを追加してください。

## 実行方法

### pipenv 環境の有効化

プロジェクトのディレクトリに移動し、以下のコマンドを実行します。

```bash
pipenv shell
```

以下のように `(midi-sampling)` というプロンプトが左側に表示されていれば、pipenv環境内です。

```bash
(midi-sampling) C:\Path\To\Project\midi-sampling>
~~~~~~~~~~~~~~~
```

### サンプリングの実行

以下のコマンドを実行します。

```bash
python midisampling/sampling.py <サンプリング設定ファイル.json> <MIDI設定ファイル.json>
```

### デバイス一覧の出力

以下のコマンドを実行します。

```bash
python python midisampling/devicelist.py
```

#### 出力例

```
+------------------------------------------------------+
|                    Audio Devices                     |
+--------------------------------+---------------------+
| Name                           | Platform            |
+--------------------------------+---------------------+
| Line(Steinberg UR28M)          | Windows WDM-KS      |
| Microsoft Sound Mapper - Input | MME                 |
| Primary Sound Capture Driver   | Windows DirectSound |
| UR28M In (Steinberg UR28M)     | MME                 |
| UR28M In (Steinberg UR28M)     | Windows DirectSound |
| UR28M In (Steinberg UR28M)     | Windows WASAPI      |
| Yamaha Steinberg USB ASIO      | ASIO                |
+--------------------------------+---------------------+
+------------------------------+
|         MIDI Devices         |
+------------------------------+
| Name                         |
+------------------------------+
| Impact GX Mini               |
| Microsoft GS Wavetable Synth |
| MIDIOUT2 (Impact GX Mini)    |
| Roland SC-8850 MIDI OUT 1    |
| Roland SC-8850 MIDI OUT 2    |
| Roland SC-8850 PART A        |
| Roland SC-8850 PART B        |
| Roland SC-8850 PART C        |
| Roland SC-8850 PART D        |
+------------------------------+
```

## 設定ファイル

サンプルとして、sampling-config.json と midi-config.example.json が同梱されています。
お使いの環境に合わせて設定してください。

<!-- Translated by ChatGPT -->
<!-- [BEGIN] Generated by documenttool/jsonschema_to_md.py -->
### サンプリング設定

*デバイス、サンプリング用の設定。*

#### プロパティ

- **`audio_channels`** *(整数, 必須)*: サンプリングされたオーディオファイルのチャンネル数。
- **`audio_sample_rate`** *(整数, 必須)*: オーディオファイルのサンプリングレート。
- **`audio_sample_bits`** *(整数, 必須)*: サンプリングされたオーディオファイルのビット深度。次のいずれかである必要があります: `[8, 16, 24, 32, 64]`。
- **`audio_sample_bits_format`** *(文字列, 必須)*: サンプリングされたオーディオファイルのビット深度の形式。次のいずれかである必要があります: `["int", "float"]`。
- **`audio_in_device`** *(オブジェクト, 必須)*
  - **`name`** *(文字列, 必須)*: サンプリングされたオーディオファイルの入力デバイスの名前。
  - **`platform`** *(文字列, 必須)*: サンプリングされたオーディオファイルの入力デバイスのプラットフォーム（例: `ASIO`, `MME`, `Windows DirectSound`, `Windows WASAPI`, `Core Audio` など）。
- **`asio_audio_ins`** *(配列)*: デフォルト: `[]`。
  - **項目** *(整数)*: ASIO入力チャンネル番号のリスト。デバイスの入力チャンネル番号を指定します。フォーマットは0から始まります（例: 入力1と2を使用する場合、`[0, 1]`を指定）。
- **`midi_out_device`** *(文字列, 必須)*: サンプリングに使用されるMIDIデバイスの名前。
- **`target_peak`** *(数値, 必須)*: サンプリングされたオーディオファイルのピークレベル（dB単位）。全体のサンプルファイルのピークレベルに基づいて正規化が行われます。
- **`trim_threshold`** *(数値)*: 無音部分をトリムするためのしきい値（dB単位）。デフォルト: `-60`。
- **`trim_min_silence_duration`** *(整数)*: トリムされる無音部分の最小持続時間（ミリ秒単位）。デフォルト: `250`。

#### 例

  ```json
  {
      "audio_channels": 2,
      "audio_sample_rate": 48000,
      "audio_sample_bits": 32,
      "audio_sample_bits_format": "int",
      "audio_in_device": {
          "name": "Yamaha Steinberg USB ASIO",
          "platform": "ASIO"
      },
      "asio_audio_ins": [
          2,
          3
      ],
      "midi_out_device": "Roland SC-8850 PART A",
      "target_peak": -8,
      "trim_threshold": -60,
      "trim_min_silence_duration": 250
  }
  ```

### MIDIサンプリング設定

*MIDIサンプリング用の設定。*

#### プロパティ

- **`output_dir`** *(文字列, 必須)*: サンプリングされたオーディオファイルの出力先ディレクトリ。
- **`processed_output_dir`** *(文字列, 必須)*: 処理されたサンプリングオーディオファイルの出力先ディレクトリ。
- **`output_prefix`** *(文字列, 必須)*: サンプリングされたオーディオファイルのファイル名の接頭辞。
- **`pre_send_smf_path_list`** *(配列)*: サンプリング前にMIDIデバイスに一度送信されるファイル（例：GMリセット、CCリセットなど）。デフォルト: `[]`。
  - **項目** *(文字列)*: SMF(*.mid/*.midi)ファイルのパス。
- **`midi_channel`** *(整数, 必須)*: サンプリングに使用されるMIDIチャンネル番号。最小: `0`。最大: `15`。
- **`midi_notes`** *(配列, 必須)*: サンプリングされるMIDIノート番号のリスト。
  - **項目** *(整数)*: 最小: `0`。最大: `127`。
- **`midi_velocities`** *(配列, 必須)*: サンプリングされるMIDIベロシティのリスト。
  - **項目** *(整数)*: 最小: `0`。最大: `127`。
- **`midi_pre_wait_duration`** *(数値, 必須)*: サンプリング前の待機時間（秒単位）。`0.6`秒以上の値が推奨されます。
- **`midi_note_duration`** *(整数, 必須)*: サンプリングされるMIDIノートの長さ（秒単位）。整数値のみ指定可能です。
- **`midi_release_duration`** *(数値, 必須)*: サンプリングされたMIDIノートのリリース後の待機時間（秒単位）。整数値のみ指定可能です。

#### 例

  ```json
  {
      "output_dir": "_recorded",
      "processed_output_dir": "_recorded/_processed",
      "output_prefix": "piano",
      "pre_send_smf_path_list": [
          "path/to/GM_Reset.mid",
          "path/to/CC_Init.mid"
      ],
      "midi_channel": 0,
      "midi_notes": [
          40
      ],
      "midi_velocities": [
          127
      ],
      "midi_pre_wait_duration": 0.6,
      "midi_note_duration": 2,
      "midi_release_duration": 1.5
  }
  ```

<!-- [END] Generated by documenttool/jsonschema_to_md.py -->
