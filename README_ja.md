midi-sampling
================


## 概要

`midi-sampling`は外部のMIDI音源からサンプリングを行います。
任意のMIDIノート・ベロシティを指定して、MIDIデバイスを制御し、サンプリングを行います。

コンソールベースで動作するため、軽量でサンプリングの自動化が可能です。

## 動作に必要なもの

- Python 3.12 以上が動作する Windows OS
  - macOSでも動作すると思いますが、未検証です
- [pipenv](https://github.com/pypa/pipenv)
- [ffmpeg](https://www.ffmpeg.org/)

## セットアップ

### pipenvのインストール

https://github.com/pypa/pipenv?tab=readme-ov-file#installation

### 依存パッケージのインストール

プロジェクトのディレクトリに移動し、以下のコマンドを実行します。

```bash
pipenv install
```

### ffmpegのインストール

https://www.ffmpeg.org/download.html

インストール後、環境変数 `PATH` に ffmpeg.exe があるディレクトリを追加してください。

## 実行方法

### pipenv 環境の有効化

プロジェクトのディレクトリに移動し、以下のコマンドを実行します。

```bash
pipenv shell
```

以下のように `(midi-sampling)` というプロンプトが左側に表示されていれば、pipenv環境内です。

```bash
(midi-sampling) C:\Path\To\Project\midi-sampling>
~~~~~~~~~~~~~~~
```

### サンプリングの実行

以下のコマンドを実行します。

```bash
python -m midisampling <サンプリング設定ファイル.json> <MIDI設定ファイル.json>
```

### デバイス一覧の出力

以下のコマンドを実行します。

```bash
python -m midisampling.device
```

#### 出力例

```
+------------------------------------------------------+
|                    Audio Devices                     |
+--------------------------------+---------------------+
| Name                           | Platform            |
+--------------------------------+---------------------+
| Line(Steinberg UR28M)          | Windows WDM-KS      |
| Microsoft Sound Mapper - Input | MME                 |
| Primary Sound Capture Driver   | Windows DirectSound |
| UR28M In (Steinberg UR28M)     | MME                 |
| UR28M In (Steinberg UR28M)     | Windows DirectSound |
| UR28M In (Steinberg UR28M)     | Windows WASAPI      |
| Yamaha Steinberg USB ASIO      | ASIO                |
+--------------------------------+---------------------+
+------------------------------+
|         MIDI Devices         |
+------------------------------+
| Name                         |
+------------------------------+
| Impact GX Mini               |
| Microsoft GS Wavetable Synth |
| MIDIOUT2 (Impact GX Mini)    |
| Roland SC-8850 MIDI OUT 1    |
| Roland SC-8850 MIDI OUT 2    |
| Roland SC-8850 PART A        |
| Roland SC-8850 PART B        |
| Roland SC-8850 PART C        |
| Roland SC-8850 PART D        |
+------------------------------+
```

## 設定ファイル

サンプルとして、sampling-config.json と midi-config.example.json が同梱されています。
お使いの環境に合わせて設定してください。

＊以下の説明文はスキーマファイルを元に機械翻訳を行っています。

<!-- Translated by ChatGPT -->
<!-- [BEGIN] Generated by documenttool/jsonschema_to_md.py -->
### サンプリング設定

*デバイス、サンプリング用の設定。*

#### プロパティ

- **`audio_channels`** *(整数, 必須)*: サンプリングされたオーディオファイルのチャンネル数。
- **`audio_sample_rate`** *(整数, 必須)*: オーディオファイルのサンプリングレート。
- **`audio_sample_bits`** *(整数, 必須)*: サンプリングされたオーディオファイルのビット深度。次のいずれかである必要があります: `[16, 24, 32]`。
- **`audio_sample_bits_format`** *(文字列, 必須)*: サンプリングされたオーディオファイルのビット深度の形式。次のいずれかである必要があります: `["int", "float"]`。
- **`audio_in_device`** *(オブジェクト, 必須)*
  - **`name`** *(文字列, 必須)*: サンプリングされたオーディオファイルの入力デバイスの名前。
  - **`platform`** *(文字列, 必須)*: サンプリングされたオーディオファイルの入力デバイスのプラットフォーム（例: `ASIO`, `MME`, `Windows DirectSound`, `Windows WASAPI`, `Core Audio` など）。
- **`asio_audio_ins`** *(配列)*: デフォルト: `[]`。
  - **項目** *(整数)*: ASIO入力チャンネル番号のリスト。デバイスの入力チャンネル番号を指定します。フォーマットは0から始まります（例: 入力1と2を使用する場合、`[0, 1]`を指定）。
- **`midi_out_device`** *(文字列, 必須)*: サンプリングに使用されるMIDIデバイスの名前。

#### 例

  ```json
  {
      "audio_channels": 2,
      "audio_sample_rate": 48000,
      "audio_sample_bits": 32,
      "audio_sample_bits_format": "int",
      "audio_in_device": {
          "name": "Yamaha Steinberg USB ASIO",
          "platform": "ASIO"
      },
      "asio_audio_ins": [
          2,
          3
      ],
      "midi_out_device": "Roland SC-8850 PART A"
  }
  ```

### MIDIサンプリング設定

*MIDIサンプリング設定の構造。*

See also `midi-config.example.json` and [schema files](midisampling/appconfig/json.schema.files/midi)

> TODO: Document JSON Schema


### オーディオプロセス構成

*オーディオプロセス構成の構造。*

#### 定義

- <a id="definitions/def_audioprocess_config"></a>**`def_audioprocess_config`** *(オブジェクト)*: 追加のプロパティを含めることはできません。
  - **`format`**: *[#/definitions/def_format](#definitions/def_format)*を参照。
  - **`keep_wav_chunks`** *(配列)*: オーディオプロセスを通じて保持するWAVチャンク名のリスト。指定しない場合、すべてのチャンクが保持されます。デフォルト: `[]`。
    - **項目** *(文字列)*

    例:
    ```json
    [
        "smpl"
    ]
    ```

    ```json
    [
        "smpl",
        "cue"
    ]
    ```

  - **`effects`** *(配列)*: オーディオプロセス構成のリスト。
    - **項目**: *[#/definitions/def_effect](#definitions/def_effect)*を参照。
- <a id="definitions/def_format"></a>**`def_format`** *(オブジェクト)*: フォーマット構成。これを依存ライブラリで明示的に指定することで、自動検出と誤変換を防ぎます。ただし、これはライブラリに依存するため保証されません。追加のプロパティを含めることはできません。
  - **`bit_depth`** *(文字列)*: オーディオファイルのビット深度。指定しない場合、入力ファイルのビット深度が依存ライブラリによって自動検出されます。以下のいずれかである必要があります: `["int16", "int24", "int32", "float32"]`。
  - **`sample_rate`** *(整数)*: オーディオファイルのサンプルレート。指定しない場合、入力ファイルのサンプルレートが依存ライブラリによって自動検出されます。
  - **`channels`** *(整数)*: オーディオファイルのチャンネル数。指定しない場合、入力ファイルのチャンネル数が依存ライブラリによって自動検出されます。
- <a id="definitions/def_effect"></a>**`def_effect`** *(オブジェクト)*: エフェクト構成。追加のプロパティを含めることはできません。
  - **`index`** *(整数、必須)*: チェーン内のエフェクトのインデックス。
  - **`name`** *(文字列、必須)*: エフェクト名。
  - **`params`** *(オブジェクト、必須)*: エフェクトのパラメータの辞書。追加のプロパティを含めることができます。
#### 例

  ```json
  [
      {
          "keep_wav_chunks": [
              "smpl"
          ],
          "format": {
              "bit_depth": "int32",
              "sample_rate": 48000,
              "channels": 2
          },
          "effects": [
              {
                  "index": 0,
                  "name": "normalize",
                  "params": {
                      "target_db": -10.0
                  }
              },
              {
                  "index": 1,
                  "name": "trim",
                  "params": {
                      "threshold_db": -65.0,
                      "min_silence_duration": 250
                  }
              }
          ]
      }
  ]
  ```

<!-- [END] Generated by documenttool/jsonschema_to_md.py -->

### オーディオプロセスのパラメータ

個々の設定内容については、以下を参照してください。
- [オーディオプロセスのパラメータ](midisampling/waveprocess/Parameters.md)
