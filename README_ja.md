midi-sampling
================


## 概要

`midi-sampling`は外部のMIDI音源からサンプリングを行います。
任意のMIDIノート・ベロシティを指定して、MIDIデバイスを制御し、サンプリングを行います。

コンソールベースで動作するため、軽量でサンプリングの自動化が可能です。

## 動作に必要なもの

- Python 3.12 以上が動作する Windows OS
  - macOSでも動作すると思いますが、未検証です
- [pipenv](https://github.com/pypa/pipenv)
- [ffmpeg](https://www.ffmpeg.org/)

## セットアップ

### pipenvのインストール

https://github.com/pypa/pipenv?tab=readme-ov-file#installation

### 依存パッケージのインストール

プロジェクトのディレクトリに移動し、以下のコマンドを実行します。

```bash
pipenv install
```

### ffmpegのインストール

https://www.ffmpeg.org/download.html

インストール後、環境変数 `PATH` に ffmpeg.exe があるディレクトリを追加してください。

## 実行方法

### pipenv 環境の有効化

プロジェクトのディレクトリに移動し、以下のコマンドを実行します。

```bash
pipenv shell
```

以下のように `(midi-sampling)` というプロンプトが左側に表示されていれば、pipenv環境内です。

```bash
(midi-sampling) C:\Path\To\Project\midi-sampling>
~~~~~~~~~~~~~~~
```

### サンプリングの実行

以下のコマンドを実行します。

```bash
python -m midisampling <サンプリング設定ファイル.json> <MIDI設定ファイル.json>
```

### デバイス一覧の出力

以下のコマンドを実行します。

```bash
python -m midisampling.device
```

#### 出力例

```
+------------------------------------------------------+
|                    Audio Devices                     |
+--------------------------------+---------------------+
| Name                           | Platform            |
+--------------------------------+---------------------+
| Line(Steinberg UR28M)          | Windows WDM-KS      |
| Microsoft Sound Mapper - Input | MME                 |
| Primary Sound Capture Driver   | Windows DirectSound |
| UR28M In (Steinberg UR28M)     | MME                 |
| UR28M In (Steinberg UR28M)     | Windows DirectSound |
| UR28M In (Steinberg UR28M)     | Windows WASAPI      |
| Yamaha Steinberg USB ASIO      | ASIO                |
+--------------------------------+---------------------+
+------------------------------+
|         MIDI Devices         |
+------------------------------+
| Name                         |
+------------------------------+
| Impact GX Mini               |
| Microsoft GS Wavetable Synth |
| MIDIOUT2 (Impact GX Mini)    |
| Roland SC-8850 MIDI OUT 1    |
| Roland SC-8850 MIDI OUT 2    |
| Roland SC-8850 PART A        |
| Roland SC-8850 PART B        |
| Roland SC-8850 PART C        |
| Roland SC-8850 PART D        |
+------------------------------+
```

## 設定ファイル

サンプルとして、sampling-config.json と midi-config.example.json が同梱されています。
お使いの環境に合わせて設定してください。

＊以下の説明文はスキーマファイルを元に機械翻訳を行っています。

<!-- Translated by ChatGPT -->
<!-- [BEGIN] Generated by documenttool/jsonschema_to_md.py -->
### サンプリング設定

*デバイス、サンプリング用の設定。*

#### プロパティ

- **`audio_channels`** *(整数, 必須)*: サンプリングされたオーディオファイルのチャンネル数。
- **`audio_sample_rate`** *(整数, 必須)*: オーディオファイルのサンプリングレート。
- **`audio_sample_bits`** *(整数, 必須)*: サンプリングされたオーディオファイルのビット深度。次のいずれかである必要があります: `[8, 16, 24, 32, 64]`。
- **`audio_sample_bits_format`** *(文字列, 必須)*: サンプリングされたオーディオファイルのビット深度の形式。次のいずれかである必要があります: `["int", "float"]`。
- **`audio_in_device`** *(オブジェクト, 必須)*
  - **`name`** *(文字列, 必須)*: サンプリングされたオーディオファイルの入力デバイスの名前。
  - **`platform`** *(文字列, 必須)*: サンプリングされたオーディオファイルの入力デバイスのプラットフォーム（例: `ASIO`, `MME`, `Windows DirectSound`, `Windows WASAPI`, `Core Audio` など）。
- **`asio_audio_ins`** *(配列)*: デフォルト: `[]`。
  - **項目** *(整数)*: ASIO入力チャンネル番号のリスト。デバイスの入力チャンネル番号を指定します。フォーマットは0から始まります（例: 入力1と2を使用する場合、`[0, 1]`を指定）。
- **`midi_out_device`** *(文字列, 必須)*: サンプリングに使用されるMIDIデバイスの名前。
- **`target_peak`** *(数値, 必須)*: サンプリングされたオーディオファイルのピークレベル（dB単位）。全体のサンプルファイルのピークレベルに基づいて正規化が行われます。
- **`trim_threshold`** *(数値)*: 無音部分をトリムするためのしきい値（dB単位）。デフォルト: `-60`。
- **`trim_min_silence_duration`** *(整数)*: トリムされる無音部分の最小持続時間（ミリ秒単位）。デフォルト: `250`。

#### 例

  ```json
  {
      "audio_channels": 2,
      "audio_sample_rate": 48000,
      "audio_sample_bits": 32,
      "audio_sample_bits_format": "int",
      "audio_in_device": {
          "name": "Yamaha Steinberg USB ASIO",
          "platform": "ASIO"
      },
      "asio_audio_ins": [
          2,
          3
      ],
      "midi_out_device": "Roland SC-8850 PART A",
      "target_peak": -8,
      "trim_threshold": -60,
      "trim_min_silence_duration": 250
  }
  ```

### MIDIサンプリング設定

*MIDIサンプリング設定の構成。*

#### 定義

- <a id="definitions/def_midi_config"></a>**`def_midi_config`** *(object)*: 主な設定構成。
  - **`output_dir`** *(string, required)*: サンプリングされた音声ファイルの出力ディレクトリ。
  - **`processed_output_dir`** *(string, required)*: 処理済みのサンプリング音声ファイルの出力ディレクトリ。
  - **`output_prefix_format`** *(文字列)*: サンプリングした音声ファイルのファイル名の接頭辞。このプレースホルダが使用可能: {pc_msb}, {pc_lsb}, {pc}, {note}, {min_velocity} {max_velocity} {velocity}。デフォルト: `"{pc}_{pc_msb}_{pc_lsb}_{note}_{velocity}"`。
  - **`pre_send_smf_path_list`** *(array)*: サンプリングの前にMIDIデバイスに送信されるファイル（例: GMリセット、CCリセットなど）。デフォルト: `[]`。
    - **Items** *(string)*: SMF(*.mid/*.midi)ファイルのパス。
  - **`midi_channel`** *(integer, required)*: サンプリング用のMIDIチャンネル番号。最小: `0`。最大: `15`。
  - **`midi_program_change_list`** *(array, required)*: サンプリング用のMIDIプログラムチェンジ（MSB、LSB、プログラム番号）のリスト。
    - **Items** *(object)*
      - **`msb`** *(integer)*: MIDIプログラムチェンジのMSB値。最小: `0`。最大: `127`。
      - **`lsb`** *(integer)*: MIDIプログラムチェンジのLSB値。最小: `0`。最大: `127`。
      - **`program`** *(integer)*: MIDIプログラムチェンジのプログラム番号。最小: `0`。最大: `127`。
  - **`midi_notes`** *(array, required)*: サンプリングするMIDIノート番号のリスト。
    - **項目**
      - **以下のいずれか**
        - : MIDIノート番号。*[#/definitions/def_midi_message_byte](#definitions/def_midi_message_byte)*を参照。
        - : MIDIノート範囲。*[#/definitions/def_midi_message_byte_range](#definitions/def_midi_message_byte_range)*を参照。
  - **`midi_velocity_layers`** *(配列, 必須)*: サンプリングするベロシティレイヤーのリスト。
    - **アイテム**: *[#/definitions/def_midivelocity_layer](#definitions/def_midivelocity_layer)* を参照。
  - **`midi_pre_wait_duration`** *(number, required)*: サンプリング前の待機時間（秒単位）。`0.6`秒以上が推奨される。
  - **`midi_note_duration`** *(integer, required)*: サンプリングするMIDIノートの長さ（秒単位）。整数値のみ指定可能。
  - **`midi_release_duration`** *(number, required)*: サンプリングされたMIDIノートのリリース後の待機時間（秒単位）。整数値のみ指定可能。

  例:
  ```json
  {
      "output_dir": "_recorded",
      "processed_output_dir": "_recorded/_processed",
      "output_prefix_format": "{pc}_{pc_msb}_{pc_lsb}_{note}_{velocity}",
      "pre_send_smf_path_list": [
          "path/to/GM_Reset.mid",
          "path/to/CC_Init.mid"
      ],
      "midi_channel": 0,
      "midi_program_change_list": [
          {
              "msb": 0,
              "lsb": 0,
              "program": 0
          },
          {
              "msb": 0,
              "lsb": 0,
              "program": 1
          },
          {
              "msb": 0,
              "lsb": 0,
              "program": 2
          }
      ],
      "midi_velocity_layers": [
          {
              "min": 0,
              "max": 63,
              "send": 63
          },
          {
              "min": 64,
              "max": 127,
              "send": 127
          }
      ],
      "midi_notes": [
          {
              "from": 40,
              "to": 43
          },
          80
      ],
      "midi_pre_wait_duration": 0.6,
      "midi_note_duration": 2,
      "midi_release_duration": 1.5
  }
  ```

- <a id="definitions/def_midi_message_byte"></a>**`def_midi_message_byte`** *(integer)*: MIDIメッセージバイトの値を表す（0-127）。最小値: `0`。最大値: `127`。
- <a id="definitions/def_integer_range"></a>**`def_integer_range`** *(object)*: 整数値の範囲を表す。
  - **`from`** *(integer)*
  - **`to`** *(integer)*

  例:
  ```json
  {
      "from": 10,
      "to": 100
  }
  ```

- <a id="definitions/def_midi_message_byte_range"></a>**`def_midi_message_byte_range`** *(object)*: MIDIメッセージバイトの値の範囲（0-127）を表す。
  - **`from`**: *[#/definitions/def_midi_message_byte](#definitions/def_midi_message_byte)*を参照。
  - **`to`**: *[#/definitions/def_midi_message_byte](#definitions/def_midi_message_byte)*を参照。

  例:
  ```json
  {
      "from": 10,
      "to": 100
  }
  ```

- <a id="definitions/def_midivelocity_layer"></a>**`def_midivelocity_layer`** *(オブジェクト)*: ベロシティレイヤー設定。
  - **`min`** *(整数, 必須)*: 最小ベロシティ値。最小値: `0`。最大値: `127`。
  - **`max`** *(整数, 必須)*: 最大ベロシティ値。最小値: `0`。最大値: `127`。
  - **`send`** *(整数, 必須)*: サンプリング時にMIDIデバイスに送信されるベロシティ値。最小値: `0`。最大値: `127`。

  例:
  ```json
  {
      "min": 0,
      "max": 127,
      "send": 127
  }
  ```

<!-- [END] Generated by documenttool/jsonschema_to_md.py -->
