midi-sampling
================


## 概要

`midi-sampling`は外部のMIDI音源からサンプリングを行います。
任意のMIDIノート・ベロシティを指定して、MIDIデバイスを制御し、サンプリングを行います。

コンソールベースで動作するため、軽量でサンプリングの自動化が可能です。

## 動作に必要なもの

- Python 3.12 以上が動作する Windows OS
  - macOSでも動作すると思いますが、未検証です
- [pipenv](https://github.com/pypa/pipenv)
- [ffmpeg](https://www.ffmpeg.org/)

## セットアップ

### pipenvのインストール

https://github.com/pypa/pipenv?tab=readme-ov-file#installation

### 依存パッケージのインストール

プロジェクトのディレクトリに移動し、以下のコマンドを実行します。

```bash
pipenv install
```

### ffmpegのインストール

https://www.ffmpeg.org/download.html

インストール後、環境変数 `PATH` に ffmpeg.exe があるディレクトリを追加してください。

## 実行方法

### pipenv 環境の有効化

プロジェクトのディレクトリに移動し、以下のコマンドを実行します。

```bash
pipenv shell
```

以下のように `(midi-sampling)` というプロンプトが左側に表示されていれば、pipenv環境内です。

```bash
(midi-sampling) C:\Path\To\Project\midi-sampling>
~~~~~~~~~~~~~~~
```

### サンプリングの実行

以下のコマンドを実行します。

```bash
python -m midisampling <サンプリング設定ファイル.json> <MIDI設定ファイル.json>
```

### デバイス一覧の出力

以下のコマンドを実行します。

```bash
python -m midisampling.device
```

#### 出力例

```
+------------------------------------------------------+
|                    Audio Devices                     |
+--------------------------------+---------------------+
| Name                           | Platform            |
+--------------------------------+---------------------+
| Line(Steinberg UR28M)          | Windows WDM-KS      |
| Microsoft Sound Mapper - Input | MME                 |
| Primary Sound Capture Driver   | Windows DirectSound |
| UR28M In (Steinberg UR28M)     | MME                 |
| UR28M In (Steinberg UR28M)     | Windows DirectSound |
| UR28M In (Steinberg UR28M)     | Windows WASAPI      |
| Yamaha Steinberg USB ASIO      | ASIO                |
+--------------------------------+---------------------+
+------------------------------+
|         MIDI Devices         |
+------------------------------+
| Name                         |
+------------------------------+
| Impact GX Mini               |
| Microsoft GS Wavetable Synth |
| MIDIOUT2 (Impact GX Mini)    |
| Roland SC-8850 MIDI OUT 1    |
| Roland SC-8850 MIDI OUT 2    |
| Roland SC-8850 PART A        |
| Roland SC-8850 PART B        |
| Roland SC-8850 PART C        |
| Roland SC-8850 PART D        |
+------------------------------+
```

## 設定ファイル

サンプルとして、sampling-config.json と midi-config.example.json が同梱されています。
お使いの環境に合わせて設定してください。

＊以下の説明文はスキーマファイルを元に機械翻訳を行っています。

<!-- Translated by ChatGPT -->
<!-- [BEGIN] Generated by documenttool/jsonschema_to_md.py -->
### サンプリング設定

*デバイス、サンプリング用の設定。*

#### プロパティ

- **`audio_channels`** *(整数, 必須)*: サンプリングされたオーディオファイルのチャンネル数。
- **`audio_sample_rate`** *(整数, 必須)*: オーディオファイルのサンプリングレート。
- **`audio_sample_bits`** *(整数, 必須)*: サンプリングされたオーディオファイルのビット深度。次のいずれかである必要があります: `[16, 32]`。
- **`audio_sample_bits_format`** *(文字列, 必須)*: サンプリングされたオーディオファイルのビット深度の形式。次のいずれかである必要があります: `["int", "float"]`。
- **`audio_in_device`** *(オブジェクト, 必須)*
  - **`name`** *(文字列, 必須)*: サンプリングされたオーディオファイルの入力デバイスの名前。
  - **`platform`** *(文字列, 必須)*: サンプリングされたオーディオファイルの入力デバイスのプラットフォーム（例: `ASIO`, `MME`, `Windows DirectSound`, `Windows WASAPI`, `Core Audio` など）。
- **`asio_audio_ins`** *(配列)*: デフォルト: `[]`。
  - **項目** *(整数)*: ASIO入力チャンネル番号のリスト。デバイスの入力チャンネル番号を指定します。フォーマットは0から始まります（例: 入力1と2を使用する場合、`[0, 1]`を指定）。
- **`midi_out_device`** *(文字列, 必須)*: サンプリングに使用されるMIDIデバイスの名前。

#### 例

  ```json
  {
      "audio_channels": 2,
      "audio_sample_rate": 48000,
      "audio_sample_bits": 32,
      "audio_sample_bits_format": "int",
      "audio_in_device": {
          "name": "Yamaha Steinberg USB ASIO",
          "platform": "ASIO"
      },
      "asio_audio_ins": [
          2,
          3
      ],
      "midi_out_device": "Roland SC-8850 PART A"
  }
  ```

### MIDIサンプリング設定

*MIDIサンプリング設定の構造。*

#### 定義

- <a id="definitions/def_midi_config"></a>**`def_midi_config`** *(オブジェクト)*: メインの設定本体。追加のプロパティを含むことはできません。
  - **`output_dir`** *(文字列, 必須)*: サンプリングされたオーディオファイルの出力ディレクトリ。
  - **`processed_output_dir`** *(文字列, 必須)*: 処理されたサンプリングオーディオファイルの出力ディレクトリ。
  - **`output_prefix_format`** *(文字列)*: サンプリングされたオーディオファイルのファイル名のプレフィックス。次のプレースホルダーが使用可能: {pc_msb}, {pc_lsb}, {pc}, {key_root}, {key_low}, {key_high}, {key_root_scale}, {key_low_scale}, {key_high_scale}, {min_velocity}, {max_velocity}, {velocity}。デフォルト: `"{pc}_{pc_msb}_{pc_lsb}_{key_root}_{velocity}"`。
  - **`scale_name_format`** *(文字列)*: キースケール名の表現形式、例：C3 = 60の科学的ピッチ表記法またはC4 = 60のヤマハ方式。プレースホルダー置換として機能します。次のいずれかである必要があります: `["SPN", "Yamaha"]`。デフォルト: `"Yamaha"`。
  - **`pre_send_smf_path_list`** *(配列)*: サンプリング前にMIDIデバイスに一度送信されるファイル（例: GMリセット, CCリセットなど）。デフォルト: `[]`。
    - **アイテム** *(文字列)*: SMF(*.mid/*.midi)ファイルのパス。
  - **`midi_channel`** *(整数, 必須)*: サンプリング用のMIDIチャンネル番号。最小: `0`。最大: `15`。
  - **`midi_program_change_list`** *(配列, 必須)*: サンプリング用のMIDIプログラムチェンジ（MSB, LSB, プログラム番号）のリスト。
    - **アイテム** *(オブジェクト)*: 追加のプロパティを含むことはできません。
      - **`msb`** *(整数)*: MIDIプログラムチェンジ用のMSB値。最小: `0`。最大: `127`。
      - **`lsb`** *(整数)*: MIDIプログラムチェンジ用のLSB値。最小: `0`。最大: `127`。
      - **`program`** *(整数)*: MIDIプログラムチェンジ用のプログラム番号。最小: `0`。最大: `127`。
  - **`velocity_layers_presets`** *(配列)*: ベロシティレイヤープリセットのリスト。`sample_zone_complex`および`sample_zone`で個別のレイヤーを定義するだけでなく、このプリセットをIDで参照することもできます。
    - **アイテム**: *[#/definitions/def_velocity_layers_preset](#definitions/def_velocity_layers_preset)*を参照。
  - **`sample_zone_complex`** *(配列)*: サンプリングされたMIDIノートのキーマップのリスト。
    - **アイテム**: *[#/definitions/def_sample_zone_complex](#definitions/def_sample_zone_complex)*を参照。
  - **`sample_zone`** *(配列)*: サンプリングされたMIDIノートのキーマップのリスト。
    - **アイテム**: *[#/definitions/def_sample_zone](#definitions/def_sample_zone)*を参照。
  - **`midi_pre_wait_duration`** *(数値, 必須)*: サンプリング前の待機時間（秒単位）。`0.6`秒以上が推奨されます。
  - **`midi_note_duration`** *(数値, 必須)*: サンプリングするMIDIノートの長さ（秒単位）。
  - **`midi_release_duration`** *(数値, 必須)*: サンプリングされたMIDIノートのリリース後の待機時間（秒単位）。整数値のみ指定可能。

  例:
  ```json
  {
      "output_dir": "_recorded",
      "processed_output_dir": "_processed",
      "output_prefix_format": "{pc}_{pc_msb}_{pc_lsb}_{key_root}_{key_low}_{key_high}_{velocity}_{min_velocity}_{max_velocity}",
      "pre_send_smf_path_list": [
          "GS_Reset.mid",
          "Reverb_Chorus_Delay_Set_0.mid"
      ],
      "midi_channel": 0,
      "midi_program_change_list": [
          {
              "msb": 0,
              "lsb": 0,
              "program": 48
          }
      ],
      "velocity_layers_presets": [
          {
              "id": 0,
              "velocities": [
                  {
                      "min": 0,
                      "max": 31,
                      "send": 31
                  },
                  {
                      "min": 32,
                      "max": 63,
                      "send": 63
                  },
                  {
                      "min": 64,
                      "max": 95,
                      "send": 95
                  },
                  {
                      "min": 96,
                      "max": 127,
                      "send": 127
                  }
              ]
          }
      ],
      "sample_zone_complex": [
          {
              "key_low": 0,
              "key_high": 32,
              "key_root": 16,
              "velocity_layers": [
                  {
                      "min": 0,
                      "max": 31,
                      "send": 31
                  },
                  {
                      "min": 32,
                      "max": 63,
                      "send": 63
                  },
                  {
                      "min": 64,
                      "max": 95,
                      "send": 95
                  },
                  {
                      "min": 96,
                      "max": 127,
                      "send": 127
                  }
              ]
          },
          {
              "key_low": 32,
              "key_high": 64,
              "key_root": 48,
              "velocity_layers_preset_id": 0
          }
      ],
      "sample_zone": [
          {
              "keys": {
                  "from": 40,
                  "to": 40
              },
              "velocity_layers": [
                  {
                      "min": 0,
                      "max": 31,
                      "send": 31
                  },
                  {
                      "min": 32,
                      "max": 63,
                      "send": 63
                  },
                  {
                      "min": 64,
                      "max": 95,
                      "send": 95
                  },
                  {
                      "min": 96,
                      "max": 127,
                      "send": 127
                  }
              ]
          },
          {
              "keys": {
                  "from": 41,
                  "to": 41
              },
              "velocity_layers_preset_id": 0
          }
      ],
      "midi_pre_wait_duration": 0.6,
      "midi_note_duration": 2.5,
      "midi_release_duration": 1.5
  }
  ```

- <a id="definitions/def_midi_message_byte"></a>**`def_midi_message_byte`** *(整数)*: MIDIメッセージバイトの値（0-127）を表します。最小: `0`。最大: `127`。
- <a id="definitions/def_integer_range"></a>**`def_integer_range`** *(オブジェクト)*: 整数の値範囲を表します。追加のプロパティを含むことはできません。
  - **`from`** *(整数, 必須)*
  - **`to`** *(整数, 必須)*

  例:
  ```json
  {
      "from": 10,
      "to": 100
  }
  ```

- <a id="definitions/def_midi_message_byte_range"></a>**`def_midi_message_byte_range`** *(オブジェクト)*: MIDIメッセージバイトの値範囲（0-127）を表します。追加のプロパティを含むことはできません。
  - **`from`**: *[#/definitions/def_midi_message_byte](#definitions/def_midi_message_byte)*を参照。
  - **`to`**: *[#/definitions/def_midi_message_byte](#definitions/def_midi_message_byte)*を参照。

  例:
  ```json
  {
      "from": 10,
      "to": 100
  }
  ```

- <a id="definitions/def_midivelocity_layer"></a>**`def_midivelocity_layer`** *(オブジェクト)*: ベロシティレイヤーの設定。追加のプロパティを含むことはできません。
  - **`min`** *(整数, 必須)*: 最小ベロシティ値。最小: `0`。最大: `127`。
  - **`max`** *(整数, 必須)*: 最大ベロシティ値。最小: `

0`。最大: `127`。
  - **`send`** *(整数, 必須)*: サンプリング時にMIDIデバイスに実際に送信されるベロシティ値。最小: `0`。最大: `127`。

  例:
  ```json
  {
      "min": 0,
      "max": 127,
      "send": 127
  }
  ```

- <a id="definitions/def_velocity_layers_preset"></a>**`def_velocity_layers_preset`** *(オブジェクト)*: ベロシティレイヤープリセットの設定。追加のプロパティを含むことはできません。
  - **`id`** *(整数, 必須)*: ベロシティレイヤープリセットのID。
  - **`velocities`** *(配列, 必須)*
    - **アイテム**:
        - : *[#/definitions/def_midivelocity_layer](#definitions/def_midivelocity_layer)*を参照。

  例:
  ```json
  {
      "id": 0,
      "velocities": [
          {
              "min": 0,
              "max": 31,
              "send": 31
          },
          {
              "min": 32,
              "max": 63,
              "send": 63
          },
          {
              "min": 64,
              "max": 95,
              "send": 95
          },
          {
              "min": 96,
              "max": 127,
              "send": 127
          }
      ]
  }
  ```

- <a id="definitions/def_sample_zone_complex"></a>**`def_sample_zone_complex`** *(オブジェクト)*: 複雑なサンプルゾーン設定。キーレンジとルートキーは明示的に指定する必要があります。追加のプロパティを含むことはできません。
  - **`key_low`** *(整数, 必須)*: キーマップ内の最も低いキー番号（ノート番号）。これはサードパーティのサンプラーソフトウェアとのマッピング情報として使用されることを意図しています。最小: `0`。最大: `127`。
  - **`key_high`** *(整数, 必須)*: キーマップ内の最も高いキー番号（ノート番号）。これはサードパーティのサンプラーソフトウェアとのマッピング情報として使用されることを意図しています。最小: `0`。最大: `127`。
  - **`key_root`** *(整数, 必須)*: キーマップ内のルートキー番号（ノート番号）。これは、サンプリング時にMIDIデバイスおよびサードパーティのサンプラーソフトウェアに送信されるノートオンメッセージの情報として使用されることを意図しています。最小: `0`。最大: `127`。
  - **`velocity_layers`** *(配列)*
    - **アイテム**:
        - : *[#/definitions/def_midivelocity_layer](#definitions/def_midivelocity_layer)*を参照。
  - **`velocity_layers_preset_id`** *(整数)*: ベロシティレイヤープリセットのID。

  例:
  ```json
  {
      "key_low": 0,
      "key_high": 32,
      "key_root": 16,
      "velocity_layers": [
          {
              "min": 0,
              "max": 31,
              "send": 31
          },
          {
              "min": 32,
              "max": 63,
              "send": 63
          },
          {
              "min": 64,
              "max": 95,
              "send": 95
          },
          {
              "min": 96,
              "max": 127,
              "send": 127
          }
      ]
  }
  ```

  ```json
  {
      "key_low": 0,
      "key_high": 32,
      "key_root": 16,
      "velocity_layers_preset_id": 0
  }
  ```

- <a id="definitions/def_sample_zone"></a>**`def_sample_zone`** *(オブジェクト)*: シンプルなサンプルゾーンの設定。複雑なバージョンとは異なり、ルートキーのみを指定でき、個々の`key_range`の値が`ルートキー`、`ロウキー`、`ハイキー`として適用されます。追加のプロパティを含むことはできません。
  - **`keys`**: キーマップ内のルートキー番号（ノート番号）。*[#/definitions/def_midi_message_byte_range](#definitions/def_midi_message_byte_range)*を参照。
  - **`velocity_layers`** *(配列)*
    - **アイテム**:
        - : *[#/definitions/def_midivelocity_layer](#definitions/def_midivelocity_layer)*を参照。
  - **`velocity_layers_preset_id`** *(整数)*: ベロシティレイヤープリセットのID。

  例:
  ```json
  {
      "keys": {
          "from": 10,
          "to": 100
      },
      "velocity_layers": [
          {
              "min": 0,
              "max": 31,
              "send": 31
          },
          {
              "min": 32,
              "max": 63,
              "send": 63
          },
          {
              "min": 64,
              "max": 95,
              "send": 95
          },
          {
              "min": 96,
              "max": 127,
              "send": 127
          }
      ]
  }
  ```

  ```json
  {
      "keys": {
          "from": 10,
          "to": 100
      },
      "velocity_layers_preset_id": 0
  }
  ```

### オーディオプロセス設定

*オーディオプロセス設定の構造。*

#### 定義

- <a id="definitions/def_postprocess_config"></a>**`def_postprocess_config`** *(オブジェクト)*: 追加のプロパティを含むことはできません。
  - **`effects`** *(配列)*: ポストプロセス設定のリスト。
    - **アイテム**: *[#/definitions/def_effect](#definitions/def_effect)*を参照。
- <a id="definitions/def_effect"></a>**`def_effect`** *(オブジェクト)*: エフェクト設定。追加のプロパティを含むことはできません。
  - **`index`** *(整数, 必須)*: チェーン内のエフェクトのインデックス。
  - **`name`** *(文字列, 必須)*: エフェクト名。
  - **`params`** *(オブジェクト, 必須)*: エフェクトのパラメータの辞書。追加のプロパティを含むことができます。

#### 例

  ```json
  [
      {
          "index": 0,
          "name": "normalize",
          "params": {
              "target_db": -10.0
          }
      },
      {
          "index": 1,
          "name": "trim",
          "params": {
              "threshold_db": -65.0,
              "min_silence_duration": 250
          }
      }
  ]
  ```

<!-- [END] Generated by documenttool/jsonschema_to_md.py -->

個々の設定内容については、以下を参照してください。
- [オーディオプロセスのパラメータ](midisampling/waveprocess/Parameters.md)
